import './app.css';
import { Layout, Row, Modal, Empty, Pagination, Result } from 'antd';
import React, { useEffect, useState, useCallback } from 'react';
import { useLocation, useHistory, withRouter } from 'react-router-dom';
import MyContext from '../../servises/Context';
import Loader from '../loader';
import SearchBox from '../search-box';
import MenuSider from '../menu-sider';
import FilmsContainer from '../films-container';
import getDataRequest from '../../servises/getDataRequest';
import defTotalRes from '../../servises/defTotalRes';
import getFromLocalStorage from '../../servises/getFromLocalStorage';
import MovieDetail from '../movie-detail';
import defGenres from '../../servises/defGenres';

const { Header, Content, Footer, Sider } = Layout;
//const API_KEY = 'eb9d8a81';
//const API_KEY = 'a6a004a3'

function App() {

  const history = useHistory()
  let location = useLocation().pathname.split('/')[1];
  let urlPage = useLocation().pathname.split('/')[2];

  const [movie, setMovie] = useState(null); //обьект ответа от сервера
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);
  const [q, setQuery] = useState('');

  const [activateModal, setActivateModal] = useState(false);
  const [detail, setShowDetail] = useState(false); //детали фильма
  const [detailRequest, setDetailRequest] = useState(false); //ответ от сервера

  const [favList, setFav] = useState(() => { return getFromLocalStorage('fav') });
  //const [favId, setFavId] = useState(() => { return getFromLocalStorage('favList') })

  const [watchList, setWatch] = useState(() => { return getFromLocalStorage('watch') });
  //const [watchId, setWatchId] = useState(() => { return getFromLocalStorage('watchList') })

  const [collapsedMenu, setCollapsedMenu] = useState(false);

  const [currPage, setCurrPage] = useState(urlPage || 1) //стр в pagination
  const [totalResults, setTotalResults] = useState(null); //кол-во ответов от сервера на  q

  const [genreList, setGenreList] = useState(() => { return defGenres(location) }); //filter menu
  const [yearValue, setYearValue] = useState(null)

  /* const getData = useCallback(() => {
    getDataRequest('s', q, setMovie, currPage, genreList, yearValue, setError, setTotalResults, setLoading, setDetailRequest);
  }, [q, currPage, genreList, yearValue]) */

  const data = { movie, setMovie, favList, setFav, watchList, setWatch, genreList, setGenreList, yearValue, setYearValue, currPage, setCurrPage, totalResults, setTotalResults, setActivateModal, detail, setShowDetail, detailRequest, setDetailRequest, setError, loading, setLoading, q, setQuery, history }

  /* useEffect(() => {
    setLoading(true);
    setError(null);
    setMovie(null)
    setTotalResults(null)
    getData()
  }, [getData]);
  //в кач-ве второго параметра может быть только примитивный обьект
  //при его изменении будет происходить ререндеринг
 */
  const onPageChange = (page) => { //при изменении стр в pagination
    setCurrPage(page)
    history.push(`/${location}/${page}`) //изменяется url на тек локацию и стр
  }

  return (
    <MyContext.Provider value={data}>
      <Layout>

        <Sider
          breakpoint="lg"
          collapsible={true}
          onCollapse={() => setCollapsedMenu(!collapsedMenu)} >

          <MenuSider
            collapsedMenu={collapsedMenu}
            setPage={setCurrPage}
            setGenre={setGenreList}
            loc={location} />
        </Sider>

        <Layout className='layout'>

          <Header className='header'>
            <SearchBox searchHandler={setQuery} />
          </Header>

          <Content>

            {error !== null &&
                <Result
                  icon={ <svg width="102" height="102" viewBox="0 0 1131 1131" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M322 571H270.8C265.68 571 262.267 574.413 262.267 579.533V613.666C262.267 618.786 265.68 622.199 270.8 622.199H322C327.12 622.199 330.533 618.786 330.533 613.666V579.533C330.533 574.413 327.12 571 322 571ZM313.467 605.133H279.333V588.066H313.466V605.133H313.467Z" fill="black" />
                    <path d="M543.867 571H492.667C487.547 571 484.134 574.413 484.134 579.533V613.666C484.134 618.786 487.547 622.199 492.667 622.199H543.867C548.987 622.199 552.4 618.786 552.4 613.666V579.533C552.4 574.413 548.987 571 543.867 571ZM535.333 605.133H501.2V588.066H535.333V605.133V605.133Z" fill="black" />
                    <path d="M629.2 571H578C572.88 571 569.467 574.413 569.467 579.533V613.666C569.467 618.786 572.88 622.199 578 622.199H629.2C634.32 622.199 637.733 618.786 637.733 613.666V579.533C637.733 574.413 634.32 571 629.2 571ZM620.667 605.133H586.534V588.066H620.667V605.133Z" fill="black" />
                    <path d="M322 263.8H270.8C265.68 263.8 262.267 267.213 262.267 272.333V306.466C262.267 311.586 265.68 314.999 270.8 314.999H322C327.12 314.999 330.533 311.586 330.533 306.466V272.333C330.533 267.213 327.12 263.8 322 263.8ZM313.467 297.933H279.333V280.867H313.466V297.933H313.467Z" fill="black" />
                    <path d="M543.867 263.8H492.667C487.547 263.8 484.134 267.213 484.134 272.333V306.466C484.134 311.586 487.547 314.999 492.667 314.999H543.867C548.987 314.999 552.4 311.586 552.4 306.466V272.333C552.4 267.213 548.987 263.8 543.867 263.8ZM535.333 297.933H501.2V280.867H535.333V297.933V297.933Z" fill="black" />
                    <path d="M629.2 263.8H578C572.88 263.8 569.467 267.213 569.467 272.333V306.466C569.467 311.586 572.88 314.999 578 314.999H629.2C634.32 314.999 637.733 311.586 637.733 306.466V272.333C637.733 267.213 634.32 263.8 629.2 263.8ZM620.667 297.933H586.534V280.867H620.667V297.933Z" fill="black" />
                    <path d="M402.213 596.6L447.44 551.373C450.853 547.96 450.853 542.84 447.44 539.426L402.213 494.2L447.44 448.973C450.853 445.56 450.853 440.44 447.44 437.026L402.213 391.8L447.44 346.573C450.853 343.16 450.853 338.04 447.44 334.626L402.213 289.4L413.306 278.307C413.306 278.307 413.306 278.307 413.307 278.306L447.44 244.173C450 241.613 450.853 238.2 449.147 234.786C448.294 231.373 444.88 229.666 441.467 229.666H219.6C205.093 229.667 194 240.76 194 255.267V272.334V306.467V579.534V613.667V630.734C194 645.241 205.093 656.334 219.6 656.334H441.467C444.88 656.334 448.294 654.627 449.147 651.214C450.854 647.801 450 644.387 447.44 641.827L402.213 596.6ZM386.853 605.133H364.666V588.066H386.853L384.293 590.626C380.88 594.039 380.88 599.159 384.293 602.573L386.853 605.133ZM386.853 297.933H364.666V280.867H386.853L384.293 283.427C383.653 284.067 383.133 284.767 382.733 285.505C382.066 286.734 381.733 288.067 381.733 289.401C381.733 290.735 382.066 292.068 382.733 293.297C383.133 294.034 383.653 294.735 384.293 295.375L386.853 297.933ZM211.067 280.867H228.134V297.934H211.067V280.867ZM211.067 588.067H228.134V605.134H211.067V588.067ZM219.6 639.267C214.48 639.267 211.067 635.854 211.067 630.734V622.2H236.667C241.787 622.2 245.2 618.787 245.2 613.667V579.534C245.2 574.414 241.787 571.001 236.667 571.001H211.067V315H236.667C241.787 315 245.2 311.587 245.2 306.467V272.333C245.2 267.213 241.787 263.8 236.667 263.8H211.067V255.267C211.067 250.147 214.48 246.734 219.6 246.734H420.987L403.92 263.8H356.133C351.013 263.8 347.6 267.213 347.6 272.333V306.466C347.6 311.586 351.013 314.999 356.133 314.999H403.92L429.52 340.599L384.293 385.826C380.88 389.239 380.88 394.359 384.293 397.773L429.52 443L384.293 488.227C380.88 491.64 380.88 496.76 384.293 500.174L429.52 545.4L403.92 571H356.133C351.013 571 347.6 574.413 347.6 579.533V613.666C347.6 618.786 351.013 622.199 356.133 622.199H403.92L420.987 639.266H219.6V639.267Z" fill="black" />
                    <path d="M680.4 229.667H492.667C490.107 229.667 488.4 230.52 486.694 232.227L435.494 283.427C432.081 286.84 432.081 291.96 435.494 295.374L480.72 340.6L435.493 385.827C432.08 389.24 432.08 394.36 435.493 397.774L480.72 443L435.493 488.227C432.08 491.64 432.08 496.76 435.493 500.174L480.72 545.4L435.493 590.627C432.08 594.04 432.08 599.16 435.493 602.574L486.693 653.774C488.4 655.481 490.106 656.334 492.666 656.334H680.4C694.907 656.334 706 645.241 706 630.734V613.667V579.534V306.467V272.333V255.267C706 240.76 694.907 229.667 680.4 229.667ZM688.933 297.933H671.866V280.867H688.933V297.933ZM680.4 639.267H496.08L453.413 596.6L498.64 551.373C502.053 547.96 502.053 542.84 498.64 539.426L453.413 494.2L498.64 448.973C502.053 445.56 502.053 440.44 498.64 437.026L453.413 391.8L498.64 346.573C502.053 343.16 502.053 338.04 498.64 334.626L453.413 289.4L496.08 246.733H680.4C685.52 246.733 688.933 250.146 688.933 255.266V263.8H663.333C658.213 263.8 654.8 267.213 654.8 272.333V306.466C654.8 311.586 658.213 314.999 663.333 314.999H688.933V570.999H663.333C658.213 570.999 654.8 574.412 654.8 579.532V613.665C654.8 618.785 658.213 622.198 663.333 622.198H688.933V630.731C688.933 635.853 685.52 639.267 680.4 639.267ZM688.933 605.133H671.866V588.066H688.933V605.133Z" fill="black" />
                    <path d="M1131 1041.54L797.101 707.637C852.526 633.674 885.785 542.206 885.785 442.893C885.785 198.669 687.116 0 442.893 0C198.669 0 0 198.669 0 442.893C0 687.116 198.669 885.785 442.893 885.785C542.206 885.785 633.674 852.526 707.637 797.101L1041.54 1131L1131 1041.54ZM42.1802 442.893C42.1802 221.931 221.931 42.1802 442.893 42.1802C663.854 42.1802 843.605 221.931 843.605 442.893C843.605 663.854 663.854 843.605 442.893 843.605C221.931 843.605 42.1802 663.854 42.1802 442.893ZM750.112 761.206C753.866 757.578 757.557 753.888 761.185 750.133C764.264 746.949 767.596 744.017 770.57 740.748L1071.36 1041.54L1041.51 1071.38L740.748 770.57C744.017 767.596 746.928 764.264 750.112 761.206Z" fill="black" fill-opacity="0.8" />
                  </svg> }
                  status="error"
                  title="Submission Failed"
                  subTitle={error}

                />


              /* < className='error-row' style={{ margin: '20px 0' }}>
                <div>
                  <svg width="500" height="500" viewBox="0 0 1131 1131" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M322 571H270.8C265.68 571 262.267 574.413 262.267 579.533V613.666C262.267 618.786 265.68 622.199 270.8 622.199H322C327.12 622.199 330.533 618.786 330.533 613.666V579.533C330.533 574.413 327.12 571 322 571ZM313.467 605.133H279.333V588.066H313.466V605.133H313.467Z" fill="black" />
                    <path d="M543.867 571H492.667C487.547 571 484.134 574.413 484.134 579.533V613.666C484.134 618.786 487.547 622.199 492.667 622.199H543.867C548.987 622.199 552.4 618.786 552.4 613.666V579.533C552.4 574.413 548.987 571 543.867 571ZM535.333 605.133H501.2V588.066H535.333V605.133V605.133Z" fill="black" />
                    <path d="M629.2 571H578C572.88 571 569.467 574.413 569.467 579.533V613.666C569.467 618.786 572.88 622.199 578 622.199H629.2C634.32 622.199 637.733 618.786 637.733 613.666V579.533C637.733 574.413 634.32 571 629.2 571ZM620.667 605.133H586.534V588.066H620.667V605.133Z" fill="black" />
                    <path d="M322 263.8H270.8C265.68 263.8 262.267 267.213 262.267 272.333V306.466C262.267 311.586 265.68 314.999 270.8 314.999H322C327.12 314.999 330.533 311.586 330.533 306.466V272.333C330.533 267.213 327.12 263.8 322 263.8ZM313.467 297.933H279.333V280.867H313.466V297.933H313.467Z" fill="black" />
                    <path d="M543.867 263.8H492.667C487.547 263.8 484.134 267.213 484.134 272.333V306.466C484.134 311.586 487.547 314.999 492.667 314.999H543.867C548.987 314.999 552.4 311.586 552.4 306.466V272.333C552.4 267.213 548.987 263.8 543.867 263.8ZM535.333 297.933H501.2V280.867H535.333V297.933V297.933Z" fill="black" />
                    <path d="M629.2 263.8H578C572.88 263.8 569.467 267.213 569.467 272.333V306.466C569.467 311.586 572.88 314.999 578 314.999H629.2C634.32 314.999 637.733 311.586 637.733 306.466V272.333C637.733 267.213 634.32 263.8 629.2 263.8ZM620.667 297.933H586.534V280.867H620.667V297.933Z" fill="black" />
                    <path d="M402.213 596.6L447.44 551.373C450.853 547.96 450.853 542.84 447.44 539.426L402.213 494.2L447.44 448.973C450.853 445.56 450.853 440.44 447.44 437.026L402.213 391.8L447.44 346.573C450.853 343.16 450.853 338.04 447.44 334.626L402.213 289.4L413.306 278.307C413.306 278.307 413.306 278.307 413.307 278.306L447.44 244.173C450 241.613 450.853 238.2 449.147 234.786C448.294 231.373 444.88 229.666 441.467 229.666H219.6C205.093 229.667 194 240.76 194 255.267V272.334V306.467V579.534V613.667V630.734C194 645.241 205.093 656.334 219.6 656.334H441.467C444.88 656.334 448.294 654.627 449.147 651.214C450.854 647.801 450 644.387 447.44 641.827L402.213 596.6ZM386.853 605.133H364.666V588.066H386.853L384.293 590.626C380.88 594.039 380.88 599.159 384.293 602.573L386.853 605.133ZM386.853 297.933H364.666V280.867H386.853L384.293 283.427C383.653 284.067 383.133 284.767 382.733 285.505C382.066 286.734 381.733 288.067 381.733 289.401C381.733 290.735 382.066 292.068 382.733 293.297C383.133 294.034 383.653 294.735 384.293 295.375L386.853 297.933ZM211.067 280.867H228.134V297.934H211.067V280.867ZM211.067 588.067H228.134V605.134H211.067V588.067ZM219.6 639.267C214.48 639.267 211.067 635.854 211.067 630.734V622.2H236.667C241.787 622.2 245.2 618.787 245.2 613.667V579.534C245.2 574.414 241.787 571.001 236.667 571.001H211.067V315H236.667C241.787 315 245.2 311.587 245.2 306.467V272.333C245.2 267.213 241.787 263.8 236.667 263.8H211.067V255.267C211.067 250.147 214.48 246.734 219.6 246.734H420.987L403.92 263.8H356.133C351.013 263.8 347.6 267.213 347.6 272.333V306.466C347.6 311.586 351.013 314.999 356.133 314.999H403.92L429.52 340.599L384.293 385.826C380.88 389.239 380.88 394.359 384.293 397.773L429.52 443L384.293 488.227C380.88 491.64 380.88 496.76 384.293 500.174L429.52 545.4L403.92 571H356.133C351.013 571 347.6 574.413 347.6 579.533V613.666C347.6 618.786 351.013 622.199 356.133 622.199H403.92L420.987 639.266H219.6V639.267Z" fill="black" />
                    <path d="M680.4 229.667H492.667C490.107 229.667 488.4 230.52 486.694 232.227L435.494 283.427C432.081 286.84 432.081 291.96 435.494 295.374L480.72 340.6L435.493 385.827C432.08 389.24 432.08 394.36 435.493 397.774L480.72 443L435.493 488.227C432.08 491.64 432.08 496.76 435.493 500.174L480.72 545.4L435.493 590.627C432.08 594.04 432.08 599.16 435.493 602.574L486.693 653.774C488.4 655.481 490.106 656.334 492.666 656.334H680.4C694.907 656.334 706 645.241 706 630.734V613.667V579.534V306.467V272.333V255.267C706 240.76 694.907 229.667 680.4 229.667ZM688.933 297.933H671.866V280.867H688.933V297.933ZM680.4 639.267H496.08L453.413 596.6L498.64 551.373C502.053 547.96 502.053 542.84 498.64 539.426L453.413 494.2L498.64 448.973C502.053 445.56 502.053 440.44 498.64 437.026L453.413 391.8L498.64 346.573C502.053 343.16 502.053 338.04 498.64 334.626L453.413 289.4L496.08 246.733H680.4C685.52 246.733 688.933 250.146 688.933 255.266V263.8H663.333C658.213 263.8 654.8 267.213 654.8 272.333V306.466C654.8 311.586 658.213 314.999 663.333 314.999H688.933V570.999H663.333C658.213 570.999 654.8 574.412 654.8 579.532V613.665C654.8 618.785 658.213 622.198 663.333 622.198H688.933V630.731C688.933 635.853 685.52 639.267 680.4 639.267ZM688.933 605.133H671.866V588.066H688.933V605.133Z" fill="black" />
                    <path d="M1131 1041.54L797.101 707.637C852.526 633.674 885.785 542.206 885.785 442.893C885.785 198.669 687.116 0 442.893 0C198.669 0 0 198.669 0 442.893C0 687.116 198.669 885.785 442.893 885.785C542.206 885.785 633.674 852.526 707.637 797.101L1041.54 1131L1131 1041.54ZM42.1802 442.893C42.1802 221.931 221.931 42.1802 442.893 42.1802C663.854 42.1802 843.605 221.931 843.605 442.893C843.605 663.854 663.854 843.605 442.893 843.605C221.931 843.605 42.1802 663.854 42.1802 442.893ZM750.112 761.206C753.866 757.578 757.557 753.888 761.185 750.133C764.264 746.949 767.596 744.017 770.57 740.748L1071.36 1041.54L1041.51 1071.38L740.748 770.57C744.017 767.596 746.928 764.264 750.112 761.206Z" fill="black" fill-opacity="0.8" />
                  </svg>
                </div>
 */

            /* <Empty description={error} type='error' /> */}



            <FilmsContainer />


            <div className='modal-detail' >
              <Modal
                title={detail.Title}
                centered
                visible={activateModal}
                onCancel={() => { setActivateModal(false); setShowDetail(null) }}
                footer={null}
              >
                {detailRequest === false ?
                  (<MovieDetail {...detail} />) : (<Loader />)}
              </Modal>
            </div>


            <Row>
              <Pagination
                current={parseInt(currPage) || parseInt(urlPage)}
                total={defTotalRes(location, favList, watchList, totalResults)}
                onChange={page => onPageChange(page)}
                hideOnSinglePage={true}
                showSizeChanger={false}
                pageSize={10}
              />
            </Row>

          </Content>

          <Footer>
            footer
              </Footer>

        </Layout>
      </Layout>
    </MyContext.Provider >

  )
}

export default withRouter(App);


